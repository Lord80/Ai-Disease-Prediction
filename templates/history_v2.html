<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Prediction History (Model v2)</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>
<body>
  <div class="wide-container history-wrap">
    <a href="/" class="back-btn">Back to Dashboard</a>
    <div class="history-toolbar">
      <h2 class="history-title">Prediction History (v2) for {{ session.username }}</h2>

      <div class="history-actions">
        <input id="historySearch" class="history-search" type="text" placeholder="🔍 Search history…">
      </div>
    </div>

    {% if history %}
      <div class="table-responsive">
        <table id="historyTable" class="table-adv">
          <thead>
            <tr>
              <th class="sortable" data-col="id">ID
                <span class="sort-indicator"></span></span>
              </th>
              <th>Fever</th>
              <th>Cough</th>
              <th>Fatigue</th>
              <th>Breathing</th>
              <th class="sortable" data-col="age">Age
                <span class="sort-indicator"></span>
              </th>
              <th>Gender</th>
              <th>BP</th>
              <th>Cholesterol</th>
              <th>Top Disease 1</th>
              <th>Top Disease 2</th>
              <th>Top Disease 3</th>
              <th>Outcome</th>
              <th class="sortable" data-col="timestamp">Date
                <span class="sort-indicator"></span>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for row in history %}
            <tr>
              <td>{{ row.id }}</td>
              <td>{{ row.fever }}</td>
              <td>{{ row.cough }}</td>
              <td>{{ row.fatigue }}</td>
              <td>{{ row.breathing }}</td>
              <td>{{ row.age }}</td>
              <td>{{ 'Male' if row.gender == 1 else 'Female' }}</td>
              <td>{{ row.bp }}</td>
              <td>{{ row.cholesterol }}</td>
              <td>
                {% if row.top_disease_1 %}
                  <span class="chip chip-blue">{{ row.top_disease_1 }}</span>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td>{% if row.top_disease_2 %}
                  <span class="chip chip-blue">{{ row.top_disease_2 }}</span>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}</td>
              <td>{% if row.top_disease_3 %}
                  <span class="chip chip-blue">{{ row.top_disease_3 }}</span>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}</td>
              <td>{{ row.outcome or '—' }}</td>
              <td data-ts="{{ row.predicted_at }}">{{ row.predicted_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="history-empty">
        <p>No history found.</p>
      </div>
    {% endif %}
  </div>

  <script>
    // 🔎 Search filter
    (function () {
      const input = document.getElementById('historySearch');
      const rows = () => Array.from(document.querySelectorAll('#historyTable tbody tr'));
      input?.addEventListener('keyup', function () {
        const q = this.value.toLowerCase();
        rows().forEach(tr => {
          tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      });
    })();

    // ⬆⬇ Sorting for ID, Age, Date
    (function () {
      const table = document.getElementById('historyTable');
      if (!table) return;
      const heads = table.querySelectorAll('th.sortable');

      heads.forEach(th => {
        th.addEventListener('click', () => {
          const col = th.getAttribute('data-col');
          const index = Array.from(th.parentNode.children).indexOf(th);
          const asc = !th.classList.contains('asc');
          heads.forEach(h => h.classList.remove('asc', 'desc'));
          th.classList.add(asc ? 'asc' : 'desc');

          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));

          const getVal = tr => tr.children[index].dataset.ts || tr.children[index].innerText.trim();

          rows.sort((a, b) => {
            let A = getVal(a), B = getVal(b);

            if (col === 'id' || col === 'age') {
              A = parseInt(A) || 0;
              B = parseInt(B) || 0;
              return asc ? A - B : B - A;
            }

            if (col === 'timestamp') {
              let dateA = new Date(A);
              let dateB = new Date(B);
              return asc ? dateA - dateB : dateB - dateA;
            }

            return asc ? A.localeCompare(B) : B.localeCompare(A);
          });

          rows.forEach(r => tbody.appendChild(r));
        });
      });
    })();
  </script>
</body>
</html>
